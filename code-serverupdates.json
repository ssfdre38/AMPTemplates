[
    {
        "UpdateStageName": "Environment Check",
        "UpdateSourcePlatform": "All",
        "UpdateSource": "Executable",
        "UpdateSourceData": "{{Linux:/bin/bash}}{{Windows:powershell.exe}}",
        "UpdateSourceArgs": "{{Linux:-c \"echo 'Environment Check:'; pwd; whoami; which wget || echo 'wget not found'; which curl || echo 'curl not found'; ls -la; echo 'Network test:'; wget -qO- https://httpbin.org/ip 2>/dev/null || curl -s https://httpbin.org/ip || echo 'No internet access'\"}}{{Windows:-NoProfile -Command \"Write-Output 'Environment Check:'; Get-Location; whoami; Get-Command wget -ErrorAction SilentlyContinue | Out-Null; if ($?) { Write-Output 'wget available' } else { Write-Output 'wget not found' }; Get-ChildItem; Write-Output 'Network test:'; try { (Invoke-WebRequest -UseBasicParsing -Uri 'https://httpbin.org/ip').Content } catch { Write-Output 'No internet access' }\"}}",
        "SkipOnFailure": true
    },
    {
        "UpdateStageName": "Code Server Download",
        "UpdateSourcePlatform": "Linux",
        "UpdateSourceArch": "x86_64",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"mkdir -p code-server && cd code-server && CodeServerVersion='{{CodeServerVersion}}'; if [[ -z '$CodeServerVersion' ]]; then echo 'Fetching latest version...'; CodeServerVersion=$(wget -qO- https://api.github.com/repos/coder/code-server/releases/latest | grep 'tag_name' | cut -d'\\\"' -f4 | sed 's/v//') || { echo 'Failed to fetch latest version'; exit 1; }; fi; echo 'Target version: '$CodeServerVersion; if [[ -x bin/code-server ]] && [[ $(./bin/code-server --version 2>/dev/null | head -n1 | awk '{print $1}' 2>/dev/null || echo 'none') == '$CodeServerVersion' ]]; then echo 'Code Server $CodeServerVersion already installed. Skipping'; exit 0; fi; echo 'Downloading Code Server $CodeServerVersion for Linux x64'; wget -qO code-server.tar.gz https://github.com/coder/code-server/releases/download/v$CodeServerVersion/code-server-$CodeServerVersion-linux-amd64.tar.gz || { echo 'Download failed from GitHub'; exit 1; }; echo 'Extracting...'; tar -xzf code-server.tar.gz --strip-components=1 || { echo 'Extract failed'; exit 1; }; rm -f code-server.tar.gz; chmod +x bin/code-server 2>/dev/null || true; echo 'Code Server $CodeServerVersion downloaded successfully'; ./bin/code-server --version || echo 'Warning: Version check failed but installation completed'\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Code Server Download",
        "UpdateSourcePlatform": "Linux",
        "UpdateSourceArch": "aarch64",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"mkdir -p code-server && cd code-server && CodeServerVersion='{{CodeServerVersion}}'; if [[ -z '$CodeServerVersion' ]]; then echo 'Fetching latest version...'; CodeServerVersion=$(wget -qO- https://api.github.com/repos/coder/code-server/releases/latest | grep 'tag_name' | cut -d'\\\"' -f4 | sed 's/v//') || { echo 'Failed to fetch latest version'; exit 1; }; fi; echo 'Target version: '$CodeServerVersion; if [[ -x bin/code-server ]] && [[ $(./bin/code-server --version 2>/dev/null | head -n1 | awk '{print $1}' 2>/dev/null || echo 'none') == '$CodeServerVersion' ]]; then echo 'Code Server $CodeServerVersion already installed. Skipping'; exit 0; fi; echo 'Downloading Code Server $CodeServerVersion for Linux ARM64'; wget -qO code-server.tar.gz https://github.com/coder/code-server/releases/download/v$CodeServerVersion/code-server-$CodeServerVersion-linux-arm64.tar.gz || { echo 'Download failed from GitHub'; exit 1; }; echo 'Extracting...'; tar -xzf code-server.tar.gz --strip-components=1 || { echo 'Extract failed'; exit 1; }; rm -f code-server.tar.gz; chmod +x bin/code-server 2>/dev/null || true; echo 'Code Server $CodeServerVersion downloaded successfully'; ./bin/code-server --version || echo 'Warning: Version check failed but installation completed'\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Code Server Download",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"$ProgressPreference='SilentlyContinue'; [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; if (-not (Test-Path 'code-server')) { New-Item -ItemType Directory -Path 'code-server' -Force | Out-Null }; Set-Location -Path 'code-server'; $CodeServerVersion='{{CodeServerVersion}}'; if ([string]::IsNullOrWhiteSpace($CodeServerVersion)) { Write-Output 'Fetching latest version...'; try { $CodeServerVersion = (Invoke-RestMethod -UseBasicParsing -Uri 'https://api.github.com/repos/coder/code-server/releases/latest').tag_name -replace '^v', '' } catch { Write-Output 'Failed to fetch latest version'; exit 1 } }; Write-Output \\\"Target version: $CodeServerVersion\\\"; if ((Test-Path 'bin\\code-server.exe') -and ((& './bin/code-server.exe' --version 2>$null | Select-Object -First 1).Split(' ')[0] -eq $CodeServerVersion)) { Write-Output \\\"Code Server $CodeServerVersion already installed. Skipping\\\"; exit 0 }; Write-Output \\\"Downloading Code Server $CodeServerVersion for Windows\\\"; try { Invoke-WebRequest -UseBasicParsing -Uri \\\"https://github.com/coder/code-server/releases/download/v$CodeServerVersion/code-server-$CodeServerVersion-windows-amd64.zip\\\" -OutFile 'code-server.zip' -ErrorAction Stop } catch { Write-Output 'Download failed from GitHub'; exit 1; }; Write-Output 'Extracting...'; try { Expand-Archive -Path 'code-server.zip' -DestinationPath '.' -Force; Remove-Item 'code-server.zip' -Force; Get-ChildItem -Directory | Where-Object { $_.Name -like 'code-server-*' } | ForEach-Object { Get-ChildItem $_.FullName | Move-Item -Destination '.' -Force; Remove-Item $_.FullName -Recurse -Force }; Write-Output \\\"Code Server $CodeServerVersion downloaded successfully\\\"; & './bin/code-server.exe' --version 2>$null || Write-Output 'Warning: Version check failed but installation completed' } catch { Write-Output 'Extract failed'; exit 1; }\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Create Workspace Directory",
        "UpdateSourcePlatform": "All",
        "UpdateSource": "Executable",
        "UpdateSourceData": "{{Linux:/bin/bash}}{{Windows:powershell.exe}}",
        "UpdateSourceArgs": "{{Linux:-c \"mkdir -p {{WorkspaceDir}} && echo 'Workspace directory created at {{WorkspaceDir}}'\"}}{{Windows:-NoProfile -Command \"if (-not (Test-Path '{{WorkspaceDir}}')) { New-Item -ItemType Directory -Path '{{WorkspaceDir}}' -Force | Out-Null }; Write-Output 'Workspace directory created at {{WorkspaceDir}}'\"}}",
        "SkipOnFailure": true
    },
    {
        "UpdateStageName": "Setup Authentication Arguments",
        "UpdateSourcePlatform": "All",
        "UpdateSource": "SetSetting",
        "UpdateSourceData": "AuthArgs",
        "UpdateSourceArgs": "{{AuthType:none:}}{{AuthType:password:--auth=password}}{{AuthType:github:--auth=github --github-client-id={{GitHubClientID}} --github-client-secret={{GitHubClientSecret}}}}",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Setup Config Arguments",
        "UpdateSourcePlatform": "All",
        "UpdateSource": "SetSetting",
        "UpdateSourceData": "ConfigArgs",
        "UpdateSourceArgs": "{{ConfigDir:--config={{ConfigDir}}}} {{UserDataDir:--user-data-dir={{UserDataDir}}}} {{ExtensionsDir:--extensions-dir={{ExtensionsDir}}}} {{DisableTelemetry:true:--disable-telemetry}}",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Setup Workspace Arguments",
        "UpdateSourcePlatform": "All",
        "UpdateSource": "SetSetting",
        "UpdateSourceData": "WorkspaceArgs",
        "UpdateSourceArgs": "{{WorkspaceDir}}",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Set Password Environment Variable",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd code-server && echo 'PASSWORD={{Password}}' > .env\"",
        "UpdateSourceConditionSetting": "AuthType",
        "UpdateSourceConditionValue": "password",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Set Password Environment Variable",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"Set-Location -Path 'code-server'; 'PASSWORD={{Password}}' | Out-File -FilePath '.env' -Encoding UTF8\"",
        "UpdateSourceConditionSetting": "AuthType",
        "UpdateSourceConditionValue": "password",
        "SkipOnFailure": false
    }
]